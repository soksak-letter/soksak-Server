// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. 유저 관련 모델 (User & Profile)
// ==========================================

model User {
  id              Int       @id @default(autoincrement()) @map("id")
  email           String    @unique @map("email")
  name            String?   @map("name")
  nickname        String?   @map("nickname")
  phoneNumber     String?   @map("phone_number")
  profileImageUrl String?   @map("profile_image_url")
  bio             String?   @map("bio")
  gender          String?   @map("gender")
  ageRange        String?   @map("age_range")
  job             String?   @map("job")
  isDeleted       Boolean   @default(false) @map("is_deleted")
  deletedAt       DateTime? @map("deleted_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @default(now()) @updatedAt @map("updated_at")
  pool            Int?
  totalUsageMinutes Int       @default(0) @map("total_usage_minutes")

  notificationSetting UserNotificationSetting?
  pushSubscriptions   PushSubscription[]
  agreements          UserAgreement[]
  auths               Auth[]
  interests           UserInterest[]
  joinedSessions      SessionParticipant[]
  writtenReviews      SessionReview[]          @relation("Reviewer")
  receivedReviews     SessionReview[]          @relation("TargetUser")
  sentLetters         Letter[]                 @relation("Sender")
  receivedLetters     Letter[]                 @relation("Receiver")
  likedLetters        LetterLike[]
  sentFriendRequests  FriendRequest[]          @relation("Requester")
  receivedFriendRequests FriendRequest[]       @relation("FriendReceiver")
  friendshipsA        Friend[]                 @relation("UserA")
  friendshipsB        Friend[]                 @relation("UserB")
  blockedUsers        Block[]                  @relation("Blocker")
  blockedBy           Block[]                  @relation("Blocked")
  reportsMade         UserReport[]             @relation("Reporter")
  reportsReceived     UserReport[]             @relation("ReportTarget")
  inquiries           Inquiry[]
  restrictions        Restriction[]
  weeklyReports       WeeklyReport[]

  @@map("user")
}

model UserNotificationSetting {
  userId           Int      @id @map("user_id")
  letterEnabled    Boolean  @default(true)  @map("letter_enabled")
  marketingEnabled Boolean  @default(false) @map("marketing_enabled")
  updatedAt        DateTime @default(now()) @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_notification_setting")
}

model PushSubscription {
  id        Int      @id @default(autoincrement()) @map("id")
  userId    Int      @map("user_id")
  endpoint  String   @unique @map("endpoint")
  p256dh    String   @map("p256dh")
  auth      String   @map("auth")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}

model UserAgreement {
  id                    Int      @id @default(autoincrement()) @map("id")
  userId                Int      @unique @map("user_id")
  termsAgreed           Boolean  @map("terms_agreed")
  privacyAgreed         Boolean  @map("privacy_agreed")
  ageOver14Agreed       Boolean  @map("age_over_14_agreed")
  marketingPushAgreed   Boolean  @map("marketing_push_agreed")
  marketingEmailAgreed  Boolean  @map("marketing_email_agreed")
  agreedAt            DateTime @default(now()) @map("agreed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_agreement")
}

// ==========================================
// 2. 인증 관련 모델 (Auth & Token)
// ==========================================

model Auth {
  id             Int      @id @default(autoincrement()) @map("id")
  userId         Int      @unique @map("user_id")
  username       String?  @unique @map("username")
  provider       String   @map("provider")
  providerUserId String?  @map("provider_user_id")
  email          String?  @unique @map("email")
  passwordHash   String?  @map("password_hash")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @default(now()) @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("auth")
}

// ==========================================
// 3. 편지 및 에셋 (Letter & Assets)
// ==========================================

model Letter {
  id             Int       @id @default(autoincrement()) @map("id")
  senderUserId   Int       @map("sender_user_id")
  receiverUserId Int?      @map("receiver_user_id")
  sessionId      Int?      @map("session_id")
  letterType     String    @map("letter_type")
  questionId     Int?      @map("question_id")
  title          String    @map("title")
  content        String    @db.Text @map("content")
  isPublic       Boolean   @map("is_public")
  status         String    @map("status")
  scheduledAt    DateTime? @map("scheduled_at")
  deliveredAt    DateTime? @map("delivered_at")
  readAt         DateTime? @map("read_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  sender   User             @relation("Sender", fields: [senderUserId], references: [id], onDelete: Cascade)
  receiver User?            @relation("Receiver", fields: [receiverUserId], references: [id], onDelete: Cascade)
  session  MatchingSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  question Question?        @relation(fields: [questionId], references: [id], onDelete: SetNull)
  
  design          LetterDesign?
  emotionTags     LetterEmotionTag[]
  aiKeywords      LetterAiKeyword[]
  likes           LetterLike[]
  reports         UserReport[]
  weeklyHighlight WeeklyReportHighlight[]

  @@index([senderUserId])
  @@index([receiverUserId])
  @@index([sessionId])
  @@index([questionId])
  @@map("letter")
}

model LetterDesign {
  letterId Int @id @map("letter_id")
  paperId  Int @map("paper_id")
  stampId  Int @map("stamp_id")
  fontId   Int @map("font_id")

  letter Letter           @relation(fields: [letterId], references: [id], onDelete: Cascade)
  paper  LetterAssetPaper @relation(fields: [paperId], references: [id])
  stamp  LetterAssetStamp @relation(fields: [stampId], references: [id])
  font   LetterAssetFont  @relation(fields: [fontId], references: [id])

  @@index([paperId])
  @@index([stampId])
  @@index([fontId])
  @@map("letter_design")
}

model LetterAssetPaper {
  id       Int            @id @default(autoincrement()) @map("id")
  color    String         @map("color")
  isActive Boolean        @map("is_active")
  designs  LetterDesign[]

  @@map("letter_asset_paper")
}

model LetterAssetStamp {
  id       Int            @id @default(autoincrement()) @map("id")
  name     String         @map("name")
  assetUrl String         @map("asset_url")
  isActive Boolean        @map("is_active")
  designs  LetterDesign[]

  @@map("letter_asset_stamp")
}

model LetterAssetFont {
  id         Int            @id @default(autoincrement()) @map("id")
  font       String         @map("font")
  isActive   Boolean        @map("is_active")
  designs    LetterDesign[]

  @@map("letter_asset_font")
}

model LetterEmotionTag {
  letterId Int    @map("letter_id")
  tag      String @map("tag")

  letter Letter @relation(fields: [letterId], references: [id], onDelete: Cascade)

  @@id([letterId, tag])
  @@map("letter_emotion_tag")
}

model LetterAiKeyword {
  letterId  Int      @map("letter_id")
  keywordId Int      @map("keyword_id")
  createdAt DateTime @default(now()) @map("created_at")

  letter  Letter    @relation(fields: [letterId], references: [id], onDelete: Cascade)
  keyword AiKeyword @relation(fields: [keywordId], references: [id])

  @@id([letterId, keywordId])
  @@index([keywordId])
  @@map("letter_ai_keyword")
}

model AiKeyword {
  id       Int               @id @default(autoincrement()) @map("id")
  name     String            @unique @map("name")
  isActive Boolean           @map("is_active")
  letters  LetterAiKeyword[]

  @@map("ai_keyword")
}

model LetterLike {
  letterId  Int      @map("letter_id")
  userId    Int      @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")

  letter Letter @relation(fields: [letterId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([letterId, userId])
  @@index([userId])
  @@map("letter_like")
}

// ==========================================
// 4. 소셜 및 관계 (Friend, Block, Report)
// ==========================================

model FriendRequest {
  id              Int      @id @default(autoincrement()) @map("id")
  requesterUserId Int      @map("requester_user_id")
  receiverUserId  Int      @map("receiver_user_id")
  sessionId       Int?     @map("session_id")
  status          String   @map("status")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")

  requester User             @relation("Requester", fields: [requesterUserId], references: [id], onDelete: Cascade)
  receiver  User             @relation("FriendReceiver", fields: [receiverUserId], references: [id], onDelete: Cascade)
  session   MatchingSession? @relation(fields: [sessionId], references: [id])

  @@index([requesterUserId])
  @@index([receiverUserId])
  @@index([sessionId])
  @@map("friend_request")
  @@unique([requesterUserId, receiverUserId], name: "requesterUserId_receiverUserId")
}

model Friend {
  id        Int      @id @default(autoincrement()) @map("id")
  userAId   Int      @map("user_a_id")
  userBId   Int      @map("user_b_id")
  createdAt DateTime @default(now()) @map("created_at")

  userA User @relation("UserA", fields: [userAId], references: [id], onDelete: Cascade)
  userB User @relation("UserB", fields: [userBId], references: [id], onDelete: Cascade)

  @@index([userAId])
  @@index([userBId])
  @@map("friend")
  @@unique([userAId, userBId], name: "userAId_userBId_unique")
}

model Block {
  blockerUserId Int      @map("blocker_user_id")
  blockedUserId Int      @map("blocked_user_id")
  createdAt     DateTime @default(now()) @map("created_at")

  blocker User @relation("Blocker", fields: [blockerUserId], references: [id], onDelete: Cascade)
  blocked User @relation("Blocked", fields: [blockedUserId], references: [id], onDelete: Cascade)

  @@id([blockerUserId, blockedUserId])
  @@index([blockedUserId])
  @@map("block")
}

model UserReport {
  id             Int      @id @default(autoincrement()) @map("id")
  reporterUserId Int      @map("reporter_user_id")
  targetUserId   Int      @map("target_user_id")
  letterId       Int?     @map("letter_id")
  status         String   @map("status")
  createdAt      DateTime @default(now()) @map("created_at")

  reporter User               @relation("Reporter", fields: [reporterUserId], references: [id], onDelete: Cascade)
  target   User               @relation("ReportTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  letter   Letter?            @relation(fields: [letterId], references: [id], onDelete: Cascade)
  reasons  UserReportReason[]

  @@index([reporterUserId])
  @@index([targetUserId])
  @@index([letterId])
  @@map("user_report")
}

model UserReportReason {
  reportId Int    @map("report_id")
  reason   String @map("reason")

  report UserReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@id([reportId, reason])
  @@map("user_report_reason")
}

// ==========================================
// 5. 주간 리포트 (Weekly Report)
// ==========================================

model WeeklyReport {
  id          Int      @id @default(autoincrement()) @map("id")
  userId      Int      @map("user_id")
  year        Int      @map("year")
  week        Int      @map("week")
  summaryText String?  @db.Text @map("summary_text")
  generatedAt DateTime @default(now()) @map("generated_at")

  user       User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  emotions   WeeklyReportEmotion[]
  keywords   WeeklyReportKeyword[]
  highlights WeeklyReportHighlight[]

  @@index([userId])
  @@map("weekly_report")
}  

model WeeklyReportEmotion {
  reportId Int    @map("report_id")
  emotion  String @map("emotion")
  ratio    Float  @map("ratio")
  count    Int    @map("count")

  report WeeklyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@id([reportId, emotion, count])
  @@map("weekly_report_emotion")
}

model WeeklyReportKeyword {
  reportId Int    @map("report_id")
  keyword  String @map("keyword")
  count    Int    @map("count")

  report WeeklyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@id([reportId, keyword])
  @@map("weekly_report_keyword")
}

model WeeklyReportHighlight {
  reportId      Int    @map("report_id")
  letterId      Int    @map("letter_id")
  highlightType String @map("highlight_type")

  report WeeklyReport @relation(fields: [reportId], references: [id], onDelete: Cascade)
  letter Letter       @relation(fields: [letterId], references: [id], onDelete: Cascade)

  @@id([reportId, letterId])
  @@index([letterId])
  @@map("weekly_report_highlight_letter")
}

// ==========================================
// 6. 기타 공통 모델
// ==========================================

model UserInterest {
  userId     Int      @map("user_id")
  interestId Int      @map("interest_id")
  createdAt  DateTime @default(now()) @map("created_at")

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  interest Interest @relation(fields: [interestId], references: [id], onDelete: Cascade)

  @@id([userId, interestId])
  @@index([interestId])
  @@map("user_interest")
}

model Interest {
  id       Int            @id @default(autoincrement()) @map("id")
  name     String         @unique @map("name")
  isActive Boolean        @default(true) @map("is_active")
  users    UserInterest[]

  @@map("interest")
}

model Question {
  id        Int      @id @default(autoincrement()) @map("id")
  content   String   @db.Text @map("content")
  isActive  Boolean  @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")

  dailyQuestions  DailyQuestion[]
  matchingSessions MatchingSession[]
  letters         Letter[]

  @@map("question")
}

model DailyQuestion {
  day         DateTime @id @db.Date @map("day")
  questionId  Int      @map("question_id")
  publishedAt DateTime @default(now()) @map("published_at")

  question Question @relation(fields: [questionId], references: [id])

  @@index([questionId])
  @@map("daily_question")
}

model MatchingSession {
  id         Int       @id @default(autoincrement()) @map("id")
  questionId Int       @map("question_id")
  status     String    @map("status") 
  maxTurns   Int       @default(10) @map("max_turns")
  startedAt  DateTime  @default(now()) @map("started_at")
  endedAt    DateTime? @map("ended_at")

  question     Question             @relation(fields: [questionId], references: [id])
  participants SessionParticipant[]
  reviews      SessionReview[]
  letters      Letter[]
  friendRequests FriendRequest[]

  @@index([questionId])
  @@map("matching_session")
}

model SessionParticipant {
  sessionId Int      @map("session_id")
  userId    Int      @map("user_id")
  role      String?  @map("role")
  joinedAt  DateTime @default(now()) @map("joined_at")

  session MatchingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([sessionId, userId])
  @@index([userId])
  @@map("session_participant")
}

model SessionReview {
  id               Int      @id @default(autoincrement()) @map("id")
  sessionId        Int      @map("session_id")
  reviewerUserId   Int      @map("reviewer_user_id")
  targetUserId     Int      @map("target_user_id")
  temperatureScore Int      @map("temperature_score")
  reviewTag        String   @map("review_tag")
  comment          String?  @db.Text @map("comment")
  createdAt        DateTime @default(now()) @map("created_at")

  session  MatchingSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  reviewer User            @relation("Reviewer", fields: [reviewerUserId], references: [id], onDelete: Cascade)
  target   User            @relation("TargetUser", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([reviewerUserId])
  @@index([targetUserId])
  @@map("session_review")
}

model Inquiry {
  id            Int       @id @default(autoincrement()) @map("id")
  userId        Int       @map("user_id")
  category      String    @map("category")
  status        String    @map("status")
  title         String    @map("title")
  content       String    @db.Text @map("content")
  answerContent String?   @db.Text @map("answer_content")
  answeredAt    DateTime? @map("answered_at")
  createdAt     DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("inquiry")
}

model Restriction {
  id        Int      @id @default(autoincrement()) @map("id")
  userId    Int      @map("user_id")
  type      String   @map("type")
  reason    String   @map("reason")
  startsAt  DateTime @map("starts_at")
  endsAt    DateTime @map("ends_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("restriction")
}

model Notice {
  id        Int      @id @default(autoincrement()) @map("id")
  title     String   @map("title")
  summary   String?  @db.VarChar(255) @map("summary") // 목록용 요약(선택)
  content   String   @db.Text @map("content")
  pinned    Boolean  @default(false) @map("pinned")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at")

  @@index([createdAt])
  @@map("notice")
}


model PolicyDocument {
  key         String   @id @map("key")
  version     String   @map("version")
  content     String   @db.Text @map("content")
  effectiveAt DateTime @map("effective_at")
  updatedAt   DateTime @default(now()) @updatedAt @map("updated_at")

  @@map("policy_document")
}


